'use strict';

const scroll = new SmoothScroll('a[href*="#"]');

/* MENU
===================================================================== */
const header = document.querySelector('.header');
const btnMenu = header.querySelector('.header__btn-menu');
const menu = header.querySelector('.header__main-nav');
const menuLinks = header.querySelectorAll('.header__main-nav-link');

if (header.classList.contains('no-js')) {
  header.classList.remove('no-js');
  btnMenu.classList.remove('active');
}

btnMenu.addEventListener('click', () => {
  showModal(menu);

  menuLinks.forEach((link) => {
    link.addEventListener('click', () => hideModal(menu));
  });
});


/* TABS
===================================================================== */
const tabList = document.querySelector('.countries__list');

const setTabListSize = () => {
  let currentWidth;

  if (window.innerWidth < 768 && window.innerWidth >= 320) currentWidth = window.innerWidth - 16;
  if (window.innerWidth < 1024 && window.innerWidth >= 768) currentWidth = window.innerWidth - 21;
  if (window.innerWidth < 1240 && window.innerWidth >= 1024) currentWidth = window.innerWidth - 35;

  tabList.style.width = currentWidth + 'px';
};

setTabListSize();
window.addEventListener('resize', setTabListSize);

/* ---------------------------------- */

const tabs = Array.from(document.querySelectorAll('.countries__list-item-link'));
const tabContents = Array.from(document.querySelectorAll('.countries__item'));
const tabLinks = Array.from(document.querySelectorAll('.places__item'));

const showTab = (index) => {
  tabs.forEach((link, i) => {
    link.classList.remove('active');
    tabContents[i].classList.remove('active');
  });

  tabs[index].classList.add('active');
  tabContents[index].classList.add('active');
};

tabs.forEach((link, index) => {
  link.addEventListener('click', () => showTab(index));
  tabLinks[index].addEventListener('click', () => showTab(index));
});


/* MODALS BUY
===================================================================== */
const overlay = document.querySelector('.overlay');
const modalSucces = document.querySelector('.modal-message');

const hideModal = (modal, withOverlay = false) => {
  const btnClose = modal.querySelector('.js-modal-close') || modal.parentElement.querySelector('.js-modal-close');

  modal.classList.remove('active');
  if (withOverlay) overlay.classList.remove('active');
  if (btnClose.classList.contains('active')) btnClose.classList.remove('active');
};

const showModal = (modal, withOverlay = false) => {
  const btnClose = modal.querySelector('.js-modal-close') || modal.parentElement.querySelector('.js-modal-close');

  window.addEventListener('click', (e) => {
    if (e.target.classList.contains('active')) hideModal(modal, withOverlay);
  });

  window.addEventListener('keydown', (e) => {
    if (e.keyCode === 27 && modal.classList.contains('active')) hideModal(modal, withOverlay);
  });

  if (withOverlay) overlay.classList.add('active');
  modal.classList.toggle('active');
  btnClose.classList.toggle('active');
};

/* BUY Modal
------------------------------------ */
const buttonsBuy = document.querySelectorAll('.js-btn-buy');
const modalBuy = document.querySelector('.modal-buy');
const inputPhone = modalBuy.querySelector('input[name="phone"]');

buttonsBuy.forEach((btn) => {
  btn.addEventListener('click', () => {
    showModal(modalBuy, true);
    inputPhone.focus();
  });
});


/* FORMS
===================================================================== */
const checkForm = (form) => {
  if (form) {
    const modalBuy = document.querySelector('.modal-buy');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      showModal(modalSucces, true);
      form.reset();
      if (form.classList.contains('modal-buy__form')) hideModal(modalBuy, false);
    });
  }

  /* STORAGE
  ------------------------------------ */
  let lsTel = '';
  let lsMail = '';
  let isLS = true;

  try {
    lsTel = localStorage.getItem('phone');
    lsMail = localStorage.getItem('mail');
  } catch (err) {
    isLS = false;
  }

  /* PHONE
  ------------------------------------ */
  const inputTel = form.querySelector('input[name="phone"]');
  const telRegex = /^([0-9]){10,20}$/;

  if (isLS) inputTel.value = lsTel;

  const checkTel = (e) => {
    const inputValue = inputTel.value;

    if (inputTel.validity.valueMissing) {
      inputTel.setCustomValidity('Обязательное поле');
      inputTel.classList.add('error');
    } else if (!telRegex.test(inputValue)) {
      inputTel.setCustomValidity('10 чисел в формате: 0123456789');
      inputTel.classList.add('error');
    } else {
      if (isLS) localStorage.setItem('phone', inputValue);
      inputTel.setCustomValidity('');
      inputTel.classList.remove('error');
    }

    if (e.type === 'input') inputTel.reportValidity();
  };

  if (inputTel) {
    inputTel.addEventListener('invalid', (e) => checkTel(e));
    inputTel.addEventListener('input', (e) => checkTel(e));
  }

  /* MAIL
  ------------------------------------ */
  const inputMail = form.querySelector('input[name="mail"]');

  if (isLS) inputMail.value = lsMail;

  const checkMail = (e) => {
    const inputValue = inputMail.value;

    if (inputMail.validity.typeMismatch) {
      inputMail.setCustomValidity('От 5 симв.: mail@mail.com');
      inputMail.classList.add('error');
    } else {
      if (isLS) localStorage.setItem('mail', inputValue);
      inputMail.setCustomValidity('');
      inputMail.classList.remove('error');
    }

    if (e.type === 'input') inputMail.reportValidity();
  };

  if (inputMail) {
    inputMail.addEventListener('invalid', (e) => checkMail(e));
    inputMail.addEventListener('input', (e) => checkMail(e));
  }
};


const formFeedback = document.querySelector('.feedback__form');
checkForm(formFeedback);
const formBuy = document.querySelector('.modal-buy__form');
checkForm(formBuy);
